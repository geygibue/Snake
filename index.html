<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snake</title>
    <script src="https://cdn.jsdelivr.net/npm/@tsparticles/confetti@3.0.3/tsparticles.confetti.bundle.min.js"></script>
    <style>
      img, audio {
        display: none;
      }
    </style>
  </head>

  <body>
    <img id="snakeHead" src="./assets/snake_head.png" alt="snake head" />
    <img id="snakeBody" src="./assets/snake_body.png" alt="snake body" />
    <img id="food" src="./assets/food.png" alt="food" />
    <img id="wall" src="./assets/wall.png" alt="wall" />
    <audio id="chew">
      <source src="./assets/chew.mp3" type="audio/ogg">
    </audio>
    <canvas id="canvas" width="300" height="300"></canvas>

    <script>
      const snakeHead = document.getElementById("snakeHead");
      const snakeBody = document.getElementById("snakeBody");
      const food = document.getElementById("food");
      const wall = document.getElementById("wall");
      const chew = document.getElementById("chew");

      confetti({
        particleCount: 1000,
        spread: 70,
        origin: { y: 0.6 },
      });

      var jatek = {
        tablaSzama: 0,
        tabla:  [
          [
            "###############",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "###############",
          ],
          [
            "###############",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "###############",
          ],
          [
            "###############",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "###############",
          ],
          [
            "###############",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "#             #",
            "###############",
          ],
        ],
        gyumik: [
          {x: 1, y: 1},
          {x: 13, y: 13},
          {x: 1, y: 13},
        ],
        pontSzam: 0,
        tickSzama: 0,
        fut: true,
        idozito: null,
        veletlenGyumolcsHozzaadas: function() {
          var randomY = Math.floor(Math.random() * (jatek.tabla[jatek.tablaSzama].length - 2)) + 1;
          var randomX = Math.floor(Math.random() * (jatek.tabla[jatek.tablaSzama][randomY].length - 2)) + 1;

          var randomHely = {x: randomX, y: randomY};
          jatek.gyumik.push(randomHely);
        },
        tick: function() {
          window.clearTimeout(jatek.idozito);
          console.log(jatek.fut);
          kigyo.mozgas();
          jatek.tablaSzama = (jatek.tablaSzama + 1) % jatek.tabla.length
          grafika.jatekMegrajzolas();
          if (!jatek.fut) {
            return
          }
          jatek.tickSzama++;
          jatek.idozito = window.setTimeout(jatek.tick, 500);
        },
      };

      var grafika = {
        canvas: document.getElementById("canvas"),
        negyzetMeret: 20,
        tablaMegrajzolas: function(ctx) {
          var aktualisYoffset = 0;
          jatek.tabla[jatek.tablaSzama].forEach(
          function sorellenorzes(sor) {
            sor = sor.split("");
            var aktualisXoffset = 0;
            
            sor.forEach(
              function karakterEllenorzes(karakter) {
                if(karakter == "#") {
                  ctx.drawImage(wall,aktualisXoffset, aktualisYoffset, grafika.negyzetMeret, grafika.negyzetMeret);
                }
                aktualisXoffset += grafika.negyzetMeret;
              }
            );
            aktualisYoffset += grafika.negyzetMeret
          }
        )},
        kigyoMegrajzolas: function(ctx) {
          var head = kigyo.reszek[0];
          kigyo.reszek.forEach(function reszMegrajzolás(resz) {
            var reszXhelye = resz.x * grafika.negyzetMeret;
            var reszYhelye = resz.y * grafika.negyzetMeret;
            ctx.drawImage(snakeBody, reszXhelye, reszYhelye, grafika.negyzetMeret, grafika.negyzetMeret);
          });
          ctx.drawImage(snakeHead, head.x * grafika.negyzetMeret, head.y * grafika.negyzetMeret, grafika.negyzetMeret, grafika.negyzetMeret);
        },
        gyumiMegrajzolas: function (ctx) {
          jatek.gyumik.forEach(function reszMegrajzolás(resz) {
            var reszXhelye = resz.x * grafika.negyzetMeret;
            var reszYhelye = resz.y * grafika.negyzetMeret;
            ctx.drawImage(food, reszXhelye, reszYhelye, grafika.negyzetMeret, grafika.negyzetMeret);
          }) 
        },
        jatekMegrajzolas: function () {
          var ctx = grafika.canvas.getContext("2d");
          ctx.clearRect(0, 0, grafika.canvas.width, grafika.canvas.height)
          grafika.tablaMegrajzolas(ctx, 0);
          grafika.gyumiMegrajzolas(ctx);
          grafika.kigyoMegrajzolas(ctx);
          ctx.font = "15px Arial";
          ctx.fillStyle = "black"
          ctx.fillText("Score: " + jatek.pontSzam, 5, 15);
          if (!jatek.fut) {
            ctx.font = "30px Arial";
            ctx.fillStyle = "red"
            ctx.fillText("Vége!", 100, 150);
          }
        },
      }

      var kigyo = {
        reszek: [
          {x: 4, y: 2},
          {x: 3, y: 2},
          {x: 2, y: 2},
        ],
        irany:"E",
        kovetkezoHely: function() {
          var kigyoFej = kigyo.reszek[0];
          var celX = kigyoFej.x;
          var celY = kigyoFej.y;
          
          if (kigyo.irany === "N") celY--;
          if (kigyo.irany === "S") celY++;
          if (kigyo.irany === "W") celX--;
          if (kigyo.irany === "E") celX++;

          return {
            x: celX,
            y: celY,
          };
        },
        mozgas: function() {
          var hely = kigyo.kovetkezoHely();
          if (kigyo.uresNegyzet(hely)) {
            kigyo.reszek.unshift(hely);
            kigyo.reszek.pop();
          }
          if (kigyo.falNegyzet(hely)) {
            jatek.fut = false;
          }
          if (kigyo.gyumolcsNegyzet(hely)) {
            kigyo.reszek.unshift(hely);
            jatek.pontSzam++;
            jatek.veletlenGyumolcsHozzaadas();
            console.log(jatek.pontSzam);
          }
          if (kigyo.kigyoNegyzet(hely)) {
            // jatek.fut = false;
            console.log("fej!test")
          }
        },
        uresNegyzet: function(hely) {
          var tartalom = jatek.tabla[jatek.tablaSzama][hely.y][hely.x]
          return tartalom === " ";
        },
        falNegyzet: function(hely) {
          var tartalom = jatek.tabla[jatek.tablaSzama][hely.y][hely.x]
          return tartalom === "#";
        },
        gyumolcsNegyzet: function(hely) {
          for (var gyumolcsSzama = 0; gyumolcsSzama < jatek.gyumik.length; gyumolcsSzama++) {
            // console.log('gyumolcsSzama', gyumolcsSzama, jatek.gyumik.length);
            if (jatek.gyumik[gyumolcsSzama].x === hely.x &&
            jatek.gyumik[gyumolcsSzama].y === hely.y) {
              jatek.gyumik.splice(gyumolcsSzama, 1);
              return true;
              chew.play();
            }
          }
          return false;
        },
        kigyoNegyzet: function(hely) {
          var fej = kigyo.reszek[0];
          for (var reszSzam = 1; reszSzam < kigyo.reszek.length; reszSzam++) {
            return kigyo.reszek[reszSzam].x === fej.x && kigyo.reszek[reszSzam].y === fej.y
          }
        }
      }

      var jatekIranyitas = {
        jatekInditas: function() {
          window.addEventListener("keypress", jatekIranyitas.gombNyomas, false);
          jatek.tick();
        },
        gombNyomas: function (gombErtek) {
          var gomb = gombErtek.key.toUpperCase();
          if (gomb === "W" && kigyo.irany !=="S") kigyo.irany = "N";
          if (gomb === "S" && kigyo.irany !=="N") kigyo.irany = "S";
          if (gomb === "A" && kigyo.irany !=="E") kigyo.irany = "W";
          if (gomb === "D" && kigyo.irany !=="W") kigyo.irany = "E";
        }
      }

      jatekIranyitas.jatekInditas();
    </script>

  </body>
</html>